<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Tale of Tokens, Cookies, and Curious Behaviors</title>
    <link rel="stylesheet" href="styles.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jsmind@0.4.8/js/jsmind.js"></script>
    <style>
        /* Basic styles for the mind map container */
        #jsmind_container {
            width: 100%;
            height: 600px;
            margin: 20px auto;
        }
    </style>
</head>
<body>
    <header>
        <h1>A Tale of Tokens, Cookies, and Curious Behaviors</h1>
        <nav>
            <ul>
                <li><a href="https://mister-cyber-chef.github.io/">·Home</a></li>
                <li><a href="bots-and-scrapers.html">·Bots and Scrapers</a></li>
                <li><a href="index3.html">·blog3</a></li>
            </ul>
        </nav>
    </header>
    <article>
        <h2>A Discovery of Rate-Limit Bypass Using Cookies</h2>
        <p>While performing penetration testing for a large tech company, I came across an interesting and unexpected behavior with their mobile API endpoints...</p>

        <!-- Mind Map Container -->
        <div id="jsmind_container"></div>

        <h3>Here's How I Found It</h3>
        <p>The mobile API had a rate limit set up...</p>

        <h3>Theories on Why This Happens (Hypothetical)</h3>
        <p>While I don’t have access to the backend systems...</p>
        <ol>
            <li><strong>Dual State Tracking Conflict:</strong> OAuth tokens authenticate stateless API requests...</li>
            <li><strong>Rate-Limit Scope Misalignment:</strong> OAuth tokens are usually scoped to users...</li>
            <li><strong>Session Context and Polluted State:</strong> Adding a session cookie could trigger some additional session-handling logic...</li>
            <li><strong>Rate-Limit Key Construction:</strong> The rate-limit key could be constructed using the OAuth token and other headers...</li>
        </ol>

        <h3>Why This Matters</h3>
        <p>While I cannot confirm the exact issue without access to the backend code...</p>

        <h3>Final Thoughts</h3>
        <p>This isn’t about finding a "flaw" in the system...</p>
    </article>
    <footer>
        <div class="centered">
            <p>&copy; 2024 The Chef's Blog</p>
        </div>
    </footer>

    <script type="text/javascript">
        // Mind map structure in JSON format
        var mind_map_data = {
            "meta": {
                "name": "jsMind",
                "version": "0.4.8"
            },
            "format": "node_tree",
            "data": {
                "id": "root",
                "topic": "Mobile/API Endpoint Behavior",
                "children": [
                    {
                        "id": "req-oauth-token",
                        "topic": "Requires a valid OAuth token for every request.",
                        "children": [
                            {
                                "id": "rate-limit-reached",
                                "topic": "Once the rate limit is reached",
                                "children": [
                                    {
                                        "id": "cookie-bypass",
                                        "topic": "Adding a cookie header with a valid flag and arbitrary value allows another batch of requests up to the original rate limit."
                                    },
                                    {
                                        "id": "token-validity",
                                        "topic": "A token is mandatory; the bypass does not work with an invalid token or cookie alone."
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        "id": "unique-parameters",
                        "topic": "Unique Parameters",
                        "children": [
                            {
                                "id": "oauth-token",
                                "topic": "OAuth token: Used for authentication."
                            },
                            {
                                "id": "session-cookie",
                                "topic": "Session cookie: Typically associated with web clients, but used in this scenario on a mobile endpoint."
                            }
                        ]
                    },
                    {
                        "id": "research-issues",
                        "topic": "Research: Problems with Using OAuth and Session Cookies Concurrently",
                        "children": [
                            {
                                "id": "dual-state-conflict",
                                "topic": "Dual State Tracking Conflict",
                                "children": [
                                    {
                                        "id": "problem",
                                        "topic": "OAuth tokens authenticate stateless API requests, while session cookies track stateful user sessions."
                                    },
                                    {
                                        "id": "conflict",
                                        "topic": "Misaligned state updates and independent rate-limit counters."
                                    },
                                    {
                                        "id": "example",
                                        "topic": "A valid token might hit the rate limit, but adding a cookie resets the limit due to separate session state tracking."
                                    }
                                ]
                            },
                            {
                                "id": "rate-limit-scope",
                                "topic": "Rate-Limit Scope Misalignment",
                                "children": [
                                    {
                                        "id": "problem",
                                        "topic": "OAuth tokens are scoped to users/clients, while session cookies are tied to browser sessions or devices."
                                    },
                                    {
                                        "id": "conflict",
                                        "topic": "Separate rate limits for token-only vs. token + cookie requests."
                                    },
                                    {
                                        "id": "example",
                                        "topic": "A token hits the limit, but adding a cookie resets it as the server treats it as a new identifier."
                                    }
                                ]
                            },
                            {
                                "id": "session-context",
                                "topic": "Session Context Pollution",
                                "children": [
                                    {
                                        "id": "problem",
                                        "topic": "Adding a session cookie triggers backend session-handling logic, leading to inconsistent state updates."
                                    },
                                    {
                                        "id": "conflict",
                                        "topic": "Backend applies different rules to cookie-based requests."
                                    },
                                    {
                                        "id": "example",
                                        "topic": "A cookie signals a web session context, overriding stricter mobile endpoint rules."
                                    }
                                ]
                            },
                            {
                                "id": "redundant-auth",
                                "topic": "Redundant or Independent Authentication Checks",
                                "children": [
                                    {
                                        "id": "problem",
                                        "topic": "OAuth enforces stateless authentication, while cookies rely on stateful validation."
                                    },
                                    {
                                        "id": "conflict",
                                        "topic": "Cookies may bypass or duplicate token validation."
                                    },
                                    {
                                        "id": "example",
                                        "topic": "A token is validated, but a cookie triggers redundant validation, allowing additional requests."
                                    }
                                ]
                            },
                            {
                                "id": "rate-limit-key",
                                "topic": "Improper Rate-Limit Key Construction",
                                "children": [
                                    {
                                        "id": "problem",
                                        "topic": "Rate-limit keys include attributes like tokens, IPs, and headers. Cookies modify key construction."
                                    },
                                    {
                                        "id": "conflict",
                                        "topic": "Cookies alter the key, resetting the rate-limit counter."
                                    },
                                    {
                                        "id": "example",
                                        "topic": "The rate-limit key for 'Token A' becomes 'Token A + Cookie X,' treated as a new entity."
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        "id": "hypotheses",
                        "topic": "Hypotheses with OAuth and Session Cookies in Mind",
                        "children": [
                            {
                                "id": "dual-counters",
                                "topic": "Dual Rate-Limiting Counters"
                            },
                            {
                                "id": "alternate-logic",
                                "topic": "Alternate Logic Path Activation"
                            },
                            {
                                "id": "dynamic-key",
                                "topic": "Dynamic Rate-Limiting Key Construction"
                            },
                            {
                                "id": "session-refresh",
                                "topic": "Session Refresh or Pollution"
                            },
                            {
                                "id": "token-cookie-desync",
                                "topic": "Token-Cookie State Desynchronization"
                            }
                        ]
                    },
                    {
                        "id": "conclusion",
                        "topic": "Conclusion",
                        "children": [
                            {
                                "id": "likely-issue",
                                "topic": "The issue likely stems from backend reconciliation of OAuth authentication and session-cookie session management."
                            },
                            {
                                "id": "root-causes",
                                "topic": "Potential Root Causes",
                                "children": [
                                    {
                                        "id": "separate-rate-limits",
                                        "topic": "Separate rate-limit counters for token-only vs. token + cookie requests."
                                    },
                                    {
                                        "id": "session-logic",
                                        "topic": "Misaligned or redundant session-handling logic."
                                    },
                                    {
                                        "id": "key-construction",
                                        "topic": "Rate-limit key construction involving both tokens and cookies."
                                    }
                                ]
                            }
                        ]
                    }
                ]
            }
        };

        // Initialize the mind map
        var jm = new jsMind({
            container: 'jsmind_container',
            theme: 'primary'
        });
        jm.show(mind_map_data);
    </script>
</body>
</html>
